---
title: "Simple Savanna"
author: "Daniel S. Godwin"
output:
  html_document:
    keep_md: true
    theme: journal
    fig_caption: true
    fig.path: 'figure_rmd/'
---
```{r echo=FALSE}

library(scales)
library(stargazer)
library(ggplot2)
library(plyr)
library(reshape2)
library(broom)
library(knitr)
library(gridExtra)

opts_chunk$set(warnings=FALSE, message=FALSE, comment=NA, fig.width=6, fig.height=6,fig.ext='png')
```

# Model growth of stems


```{r Model, echo=TRUE}
source("Scripts/Model.R")

Runs <- 5000
Trees <- 500
TL <- 50

All <- Fxn_IntegrativeSavannaTopkillModel(Runs_Set = Runs, Trees = Trees, TL = TL,
                                          GrowthFlat = "Positive",
                                          IntensityFlat = FALSE,
                                          FireFrequencyFlat = FALSE,
                                          FileName = "All")

GrowthFlat <- Fxn_IntegrativeSavannaTopkillModel(Runs_Set = Runs, Trees = Trees, TL = TL,
                                                 IntensityFlat = FALSE,
                                                 FireFrequencyFlat = FALSE,
                                                 GrowthFlat = "Flat",
                                                 FileName = "GrowthFlat")

GrowthPositive <- Fxn_IntegrativeSavannaTopkillModel(Runs_Set = Runs, Trees = Trees, TL = TL,
                                                     IntensityFlat = FALSE,
                                                     FireFrequencyFlat = FALSE,
                                                     GrowthFlat = "Positive",
                                                     FileName = "GrowthPositive")

GrowthNegative <- Fxn_IntegrativeSavannaTopkillModel(Runs_Set = Runs, Trees = Trees, TL = TL,
                                                    IntensityFlat = FALSE,
                                                    FireFrequencyFlat = FALSE,
                                                    GrowthFlat = "Negative",
                                                    FileName = "NegativeGrowth")

GrowthVaries <- Fxn_IntegrativeSavannaTopkillModel(Runs_Set = Runs, Trees = Trees, TL = TL,
                                                    GrowthFlat = "Positive",
                                                    FireFrequencyFlat = TRUE,
                                                    IntensityFlat = TRUE,
                                                    FileName = "GrowthVaries")



IntensityVaries <- Fxn_IntegrativeSavannaTopkillModel(Runs_Set = Runs, Trees = Trees, TL = TL,
                                                    GrowthFlat = "Flat",
                                                    FireFrequencyFlat = TRUE,
                                                    IntensityFlat = FALSE,
                                                    FileName = "IntensityVaries")

MFRIVaries <- Fxn_IntegrativeSavannaTopkillModel(Runs_Set = Runs, Trees = Trees, TL = TL,
                                               GrowthFlat = "Flat",
                                               IntensityFlat = TRUE,
                                               FireFrequencyFlat = FALSE, FileName = "MFRIVaries")

MAP_low <- 400
MAP_high <- 900
MAP_seq <- 50

All_summary <- Summary_TreeHeights(All,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
GrowthFlat_summary <- Summary_TreeHeights(GrowthFlat,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
GrowthPositive_summary <- Summary_TreeHeights(GrowthPositive,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
GrowthNegative_summary <- Summary_TreeHeights(GrowthNegative,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
GrowthVaries_summary <- Summary_TreeHeights(GrowthVaries,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
IntensityVaries_summary <- Summary_TreeHeights(IntensityVaries,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
MFRIVaries_summary <- Summary_TreeHeights(MFRIVaries,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)

pEscape_All <- Summary_pEscape(All,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
pEscape_GrowthFlat <- Summary_pEscape(GrowthFlat,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
pEscape_GrowthPositive <- Summary_pEscape(GrowthPositive,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
pEscape_GrowthNegative <- Summary_pEscape(GrowthNegative,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
pEscape_GrowthVaries <- Summary_pEscape(GrowthVaries,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
pEscape_IntensityVaries <- Summary_pEscape(IntensityVaries,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)
pEscape_MFRIVaries <- Summary_pEscape(MFRIVaries,MAP_low = MAP_low, MAP_high = MAP_high, MAP_sequence = MAP_seq)




```

```{r fig_FIMAP, echo=FALSE}
FI_recover <- data.frame(MAP = numeric(0),PlotFI=numeric(0))

FI_recover <- rbind(FI_recover,data.frame(Rainfall_mm = rep.int(x = 496,times = 229),PlotFI=NA))
FI_recover <- rbind(FI_recover,data.frame(Rainfall_mm = rep.int(x = 544,times = 342),PlotFI=NA))
FI_recover <- rbind(FI_recover,data.frame(Rainfall_mm = rep.int(x = 550,times = 306),PlotFI=NA))
FI_recover <- rbind(FI_recover,data.frame(Rainfall_mm = rep.int(x = 737,times = 360),PlotFI=NA))
FI_recover$PlotFI <- Fxn_FireIntensity_RedoneHistoricalEBP(MAP = FI_recover$Rainfall_mm)
FI_recover$Type <- "Simulated"
original <- historicalEBP[c("Rainfall_mm","PlotFI")]
original$Type <- "Original"
compareFI <- rbind(FI_recover,original)

MAP_pred <- data.frame(Rainfall_mm = seq(400,900,1))
EBP_Intensity_by_MAP_pred <- predict.glm(object = EBP_Intensity_by_MAP, type = "link", newdata = MAP_pred,se.fit = TRUE)
EBP_Intensity_by_MAP_pred <- tidy(EBP_Intensity_by_MAP_pred)
EBP_Intensity_by_MAP_pred <- cbind(MAP_pred,EBP_Intensity_by_MAP_pred)

EBP_Intensity_by_MAP_pred$upper.ci <- EBP_Intensity_by_MAP_pred$fit+(1.96 * (EBP_Intensity_by_MAP_pred$se.fit))
EBP_Intensity_by_MAP_pred$lower.ci <- EBP_Intensity_by_MAP_pred$fit-(1.96 * (EBP_Intensity_by_MAP_pred$se.fit))
EBP_Intensity_by_MAP_pred$fit <- EBP_Intensity_by_MAP_pred$fit

EBP_Intensity_by_MAP_pred$Published <- Fxn_FireIntensity_Original(EBP_Intensity_by_MAP_pred$Rainfall_mm)

fig_EBP_Intensity_by_MAP <- ggplot(data = EBP_Intensity_by_MAP_pred, aes(x = Rainfall_mm, y = fit))+
  geom_boxplot(data = original, aes(x = Rainfall_mm, y = PlotFI, group = Rainfall_mm),position = "dodge")+
  geom_line(color = "black")+
  geom_line(color = "red", aes( x = Rainfall_mm, y = Published))+
  geom_line(linetype = "dashed", aes(x = Rainfall_mm, y = upper.ci))+
  geom_line(linetype = "dashed", aes(x = Rainfall_mm, y = EBP_Intensity_by_MAP_pred$lower.ci))+
  ylab("Intensity (kW / m^2)")+
  xlab("Mean Annual Precipitation (mm)")+
  cleanTheme
fig_EBP_Intensity_by_MAP


original$RainfallFacet <- as.factor(as.character(original$Rainfall_mm))

levels(original$RainfallFacet ) <- c("496 mm / yr","544 mm / yr", "550 mm / yr","737 mm / yr")

FI_recover$RainfallFacet <- as.factor(as.character(FI_recover$Rainfall_mm))

levels(FI_recover$RainfallFacet ) <- c("496 mm / yr","544 mm / yr", "550 mm / yr","737 mm / yr")



fig_EBP_density <- ggplot()+
  geom_histogram(data = original, binwidth = 500, fill = "white", color = "black", aes(x = PlotFI, y=..density..))+
  geom_density(data = FI_recover, fill = "gray50", alpha = .5, aes(x = PlotFI))+
  cleanTheme+
  ylab("Kernal density")+
  xlab("Fire Intensity (kW / m)")+
  facet_wrap(~RainfallFacet)+
  scale_y_continuous(labels = comma)
fig_EBP_density



```

## Growth by MAP

```{r fig_GrowthMAP, echo=FALSE}
source("Scripts/Growth.R")

dummyMAPDF <- data.frame(MAP = seq(400,900,1))

Growth <- predict.lm(object = growthModel, newdata = list(MAP = dummyMAPDF$MAP),interval = "confidence")
Growth_Mopane <- predict.lm(object = COMO_growthModel, newdata = list(MAP = dummyMAPDF$MAP),interval = "confidence")
Growth_Mopane<- tidy(Growth_Mopane)
names(Growth_Mopane) <- c("Mopane_fit","Mopane_upper","Mopane_lower")

Growth <- tidy(Growth)

Growth <- cbind(Growth,dummyMAPDF)
Growth <- cbind(Growth,Growth_Mopane)

Growth_wide <- melt(Growth,measure.vars = c("fit","Mopane_fit"), id.vars = "MAP")
Growth_ribbon <- melt(Growth,measure.vars = c("lwr","upr","Mopane_upper","Mopane_lower"), id.vars = "MAP")

levels(Growth_wide$variable) <- c("Positive Growth Rate","Negative Growth Rate")

fig_GrowthMAP <- ggplot()+
  geom_line(data = Growth_wide, aes(x = MAP, y = value, linetype = variable))+
  geom_ribbon(data = Growth, alpha = .5, aes(x = MAP, ymin = lwr, ymax = upr))+
  geom_ribbon(data = Growth, alpha = .5,aes(x = MAP, ymin = Mopane_lower, ymax = Mopane_upper))+
  geom_point(data = bothGrowth, size = 3, aes(x = MAP, y = Growth, shape = Type))+
  scale_linetype_discrete(name="Growth Rate Predictions",
                            breaks=c("Positive Growth Rate","Negative Growth Rate"),
                            labels=c("Positive Growth Rate","Negative Growth Rate"))+
      scale_shape_discrete(name ="Samples",
                           breaks=c("Negative Growth Samples","Positive Growth Samples"),
                           labels=c("Negative Growth Rate","Positive Growth Rate"))+
 # geom_line(data = Growth, size = 2, alpha = .5, linetype = "dashed", aes(x = MAP, y = Mopane_fit))+
# ylim(20,75)+
# xlim(400,1000)+
  ylab("Growth Rate (cm / yr)")+
  xlab("Mean Annual Precipitation (mm / yr)")+
  cleanTheme+
  theme(legend.position="bottom",legend.direction="vertical")
fig_GrowthMAP

```



## Distribution of Heights by MAP

```{r Fig_heightDistributions}
# distributionsPlot <- ggplot(data=GrowthVaries_summary,aes(x=as.numeric(as.character(Height_Cuts))/100,y = Proportion, fill=as.factor(MAP_Cuts),group=MAP_Cuts))
# distributionsPlot+
#   cleanTheme+
#   scale_fill_discrete("Mean Annual Precipitation (mm/yr)")+
#   theme(text = element_text(size = 35),
#         legend.background = element_rect(),
#         legend.position="bottom")+
#   guides(col = guide_legend(ncol = 4))+
#   ylab("Proportion")+
#   xlab("Height (m)")+
#   geom_bar(stat="identity",binwidth=25, position="dodge")
```

```{r}
#glm_pEscape_null <- glm(data = na.omit(pEscape), pResult ~ 1, family = "binomial")
Fxn_pEscape_pred <- function(df){
  dummyMAPDF <- data.frame(MAP = seq(400,900,10))
  
  glm_pEscape_MAP <- glm(data = na.omit(df), pResult ~ MAP_Cuts, family = "quasibinomial")

  pEscape_pred <- predict.glm(object = glm_pEscape_MAP, type = "link", newdata = list(MAP_Cuts = dummyMAPDF$MAP),se.fit = TRUE)
  pEscape_pred <- tidy(pEscape_pred)
  pEscape_pred <- cbind(pEscape_pred,dummyMAPDF)

  pEscape_pred$upper.ci <- plogis(pEscape_pred$fit+(1.96 * (pEscape_pred$se.fit)))
  pEscape_pred$lower.ci <- plogis(pEscape_pred$fit-(1.96 * (pEscape_pred$se.fit)))

  pEscape_pred$fit <- inv.logit(pEscape_pred$fit)
  
  return(pEscape_pred)
}

pEscape_pred_All <- Fxn_pEscape_pred(pEscape_All)
pEscape_pred_GrowthFlat <- Fxn_pEscape_pred(df = pEscape_GrowthFlat)
pEscape_pred_GrowthNegative <- Fxn_pEscape_pred(df = pEscape_GrowthNegative)
pEscape_pred_GrowthPositive <- Fxn_pEscape_pred(df = pEscape_GrowthPositive)
pEscape_pred_GrowthVaries <- Fxn_pEscape_pred(df = pEscape_GrowthVaries)
pEscape_pred_IntensityVaries <- Fxn_pEscape_pred(df = pEscape_IntensityVaries)
pEscape_pred_MFRIVaries <- Fxn_pEscape_pred(df = pEscape_MFRIVaries)

pEscape_pred_All$Type <- "Standard Model"
pEscape_pred_GrowthFlat$Type <- "Growth Flat with MAR"
pEscape_pred_GrowthPositive$Type <- "Growth Positive with MAR"
pEscape_pred_GrowthNegative$Type <- "Growth Negative with MAR"
pEscape_pred_GrowthVaries$Type <- "Only Growth Varies with MAR"
pEscape_pred_IntensityVaries$Type <- "Only Intensity Varies with MAR"
pEscape_pred_MFRIVaries$Type <- "Only MFRI Varies with MAR"

pEscape_pred <- rbind.data.frame(pEscape_pred_All,pEscape_pred_GrowthFlat,pEscape_pred_GrowthPositive,pEscape_pred_GrowthNegative,pEscape_pred_IntensityVaries,pEscape_pred_MFRIVaries,pEscape_pred_GrowthVaries)

pEscape_pred$Type <- as.factor(pEscape_pred$Type)

```

## Probability of Escape by MAP

```{r Fig_pEscape, echo=FALSE}
pEscape_pred_sub <- subset(pEscape_pred,Type =="Growth Negative with MAR" | Type == "Growth Flat with MAR" | Type == "Growth Positive with MAR")

#pEscape_pred_sub_basic <- subset(pEscape_pred,Type == "Standard Model")
#pEscape_pred_sub_basic <- rbind(pEscape_pred_sub_basic,pEscape_pred_sub)

fig_pEscape <- ggplot(pEscape_pred_sub)+
 # geom_point(aes(x = MAP, y = fit, color = Type))+
 # ylim(0.7,1)+
  geom_line(data = pEscape_pred_sub, size = 1.5, aes(x = MAP, y = fit, color = Type))+
  scale_color_colorblind("Model Type")+
  geom_ribbon(data = pEscape_pred_sub, alpha = .25, aes(x = MAP, ymax = upper.ci, ymin = lower.ci, factor = Type))+
#  geom_line(linetype = "dashed", data = pEscape_pred_sub_basic, aes(x = MAP, y = lower.ci, color=Type))+
  ylab("p(Escape, 3 m sapling)")+
  xlab("Mean Annual Precipitation (mm/yr)")+
  cleanTheme+
  theme(legend.position="none",legend.direction="vertical")+
  facet_wrap(~Type)
  #theme(legend.justification=c(1,1), legend.position=c(.98,.98))
fig_pEscape
```

```{r Fig_pEscale_CompareMAR_Variation, echo=FALSE}
pEscape_pred_subVar <- subset(pEscape_pred, Type == "Standard Model" | Type == "Only MFRI Varies with MAR" | Type == "Only Intensity Varies with MAR" | Type == "Only Growth Varies with MAR")
fig_pEscape_All <- ggplot(pEscape_pred_subVar)+
 # geom_point(aes(x = MAP, y = fit, color = Type))+
  geom_line(data = pEscape_pred_subVar, size = 1.5, aes(x = MAP, y = fit, color = Type))+
  geom_ribbon(data = pEscape_pred_subVar, alpha = .25, aes(x = MAP, ymax = upper.ci, ymin = lower.ci, factor = Type))+
  scale_color_colorblind("Model Type")+
  ylab("p(Escape, 3 m sapling)")+
  xlab("Mean Annual Precipitation (mm/yr)")+
  cleanTheme+
  theme(legend.position="none",legend.direction="vertical")+
  facet_wrap(~Type)
  #theme(legend.justification=c(1,1), legend.position=c(.98,.98))
fig_pEscape_All
```

```{r whatControlsWhat_dataPrep}
pEscape_melt <- melt(pEscape_pred,id.vars = c("Type","MAP"),measure.vars = "fit")
pEscape_wide <- dcast(pEscape_melt,MAP ~ Type,value.var = "value")

names(pEscape_wide) <- c("MAP","GrowthFlat","GrowthNegative","GrowthPositive","GrowthVaries","IntensityFlat","MFRIFlat","Standard")
```

```{r Fig_varianceOfModel,echo=FALSE}
fig_GrowthFlat <- ggplot(pEscape_wide)+
  ylim(.85,1)+
  xlim(.85,1)+
  geom_line(colour="gray50",aes(x = Standard, y = Standard))+
  geom_line(linetype = "dashed", aes(x = GrowthVaries, y = Standard))+
  xlab("Model Predictions:\nOnly Growth Varies with MAR")+
  ylab("Standard Model Predictions")+
  cleanTheme

fig_MFRIFlat <- ggplot(pEscape_wide)+
  ylim(.85,1)+
  xlim(.85,1)+
  geom_line(colour="gray50",aes(x = Standard, y = Standard))+
  geom_line(linetype = "dashed", aes(x = MFRIFlat, y = Standard))+
  xlab("Model Predictions:\nOnly MFRI Varies with MAR")+
  ylab("Standard Model Predictions")+
  cleanTheme

fig_IntensityFlat <- ggplot(pEscape_wide)+
  xlim(.85,1)+
  ylim(.85,1)+
  geom_line(colour="gray50",aes(x = Standard, y = Standard))+
  geom_line(linetype = "dashed", aes(x = IntensityFlat, y = Standard))+
  xlab("Model Predictions:\nOnly Intensity Varies with MAR")+
  ylab("Standard Model Predictions")+
  cleanTheme

grid.arrange(fig_GrowthFlat,fig_MFRIFlat,fig_IntensityFlat,nrow=1)

```

```{r whatControlsWhat_Models}
lm_growthVaries <- lm(Standard~GrowthVaries,pEscape_wide)
lm_MFRIFlat <- lm(Standard~MFRIFlat,pEscape_wide)
lm_intensityFlat <- lm(Standard~IntensityFlat,pEscape_wide)

growthVariesDF <- glance(lm_growthVaries)
growthVariesDF$Model <- "Standard ~ Growth Varies"

MFRIVariesDF <- glance(lm_MFRIFlat)
MFRIVariesDF$Model <- "Standard ~ MFRI Varies"

intensityVariesDF <- glance(lm_intensityFlat)
intensityVariesDF$Model <- "Standard ~ Intensity Varies"

modelCompareDF <- rbind(growthVariesDF,MFRIVariesDF,intensityVariesDF)




