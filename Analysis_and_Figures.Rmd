---
title: "Simple Savanna"
author: "Daniel S. Godwin"
output:
  html_document:
    keep_md: true
    theme: journal
    fig_caption: true
    fig.path: 'figure_rmd/'
---
```{r echo=FALSE}


library(stargazer)
library(ggplot2)
library(plyr)
library(reshape2)
library(broom)
library(knitr)

opts_chunk$set(warnings=FALSE, message=FALSE, comment=NA, fig.width=6, fig.height=6,fig.ext='png')
```

```{r sourceMFRI, echo = TRUE, cache=TRUE}
source("Scripts/MFRI_MAP.R")
```

# Model Mean Fire Return Interval as a function of Mean Annual Rainfall

# Figures

### MFRI vs. MAP

```{r fig_MFRI_MAP, echo=FALSE, warnings = FALSE, message=FALSE}
modelCompare_binom <- ggplot(data = MAP_FF_modelCompare, aes(x = MAP_mm, y = MFRI))+
  geom_jitter(alpha = .55, color = "gray90")+
  geom_line(color = "black", aes(x = MAP_mm, y = MAP_FF_modelCompare$predicted))+
  geom_line(color = "gray50", aes(x = MAP_mm, y = MAP_FF_modelCompare$usd))+
  geom_line(color = "gray50", aes(x = MAP_mm, y = MAP_FF_modelCompare$lsd))+
  ylab("Mean Fire Return Interval (Yr)")+
  xlab("Mean Annual Precipitation (mm)")+
  cleanTheme
modelCompare_binom
```

### FF vs. MAP

```{r fig_FF_MAP, echo=FALSE}
modelCompare_binom <- ggplot(data = MAP_FF_modelCompare, aes(x = MAP_mm, y = 1/MFRI))+
  geom_jitter(alpha = .50, color = "gray90")+
  ylim(0,1)+
  geom_line(color = "black", aes(x = MAP_mm, y = 1/MAP_FF_modelCompare$predicted))+
  geom_line(color = "gray50", aes(x = MAP_mm, y = 1/MAP_FF_modelCompare$usd))+
  geom_line(color = "gray50", aes(x = MAP_mm, y = 1/MAP_FF_modelCompare$lsd))+
  # geom_smooth(method = "glm", family="Gamma", formula = y ~ x, fill = "gray85", size = 2)+
  ylab("Fire Frequency (Fires / Yr)")+
  xlab("Mean Annual Precipitation (mm)")+
  cleanTheme
modelCompare_binom
```

## Model Comparison

```{r modelCompare_Plot, echo=FALSE}
modelCompare_plot <- ggplot(data = MAP_FF_modelCompare, aes(x = MFRI, y = predicted))+
  geom_point(alpha = .01)+
  coord_fixed()+
  ylab("Predicted")+
  xlab("Real")+
  cleanTheme
modelCompare_plot
```

### lm MFRI ~ Predicted 

```{r modelCompare, echo=FALSE,results='asis'}
stargazer(lm(MFRI ~ predicted, data = MAP_FF_modelCompare),type = "html")
```

# Model Fuel Load and Intensity as a function of MFRI and MAP

```{r sourceIntensity_MAP, echo=TRUE}
source("Scripts/Intensity_MAP.R")
```

## Figures

# Model growth of stems


```{r echo=TRUE}
source("Scripts/Growth.R")

# Create empty dataframes ----
  
  treeHeightList <- numeric(0)
  fireIntensityList <- numeric(0)
  treeHeightsByMAP <- list(0)
  intensityByMAP <- list(0)

# Define start conditions ----

  timeLimit <- 50
  treeNumbers <- 100
  Runs <- 1000
  MAP_previous <- 0

  GrowthFlat <- FALSE
  IntensityFlat <- FALSE
  FireFrequencyFlat <- FALSE

# Write model metadata:
  simTime <- Sys.time()
  
  simMetadata <- data.frame(simTime,
                            timeLimit,
                            treeNumbers,
                            Runs,
                            GrowthFlat,
                            IntensityFlat,
                            FireFrequencyFlat)

# Model ----

  for(u in 1:Runs){
    
  randomLine <- sample(x = nrow(MFRI_expand),size = 1, replace = FALSE)
  MAP_seed <- MFRI_expand[randomLine,1]
  FireFrequency <- 1/MFRI_expand[randomLine,2]
  
 
  
  if(!is.numeric(MAP_seed)){
    while(!is.numeric(MAP_seed)){
      randomLine <- sample(x = nrow(MFRI_expand),size = 1, replace = FALSE)
  MAP_seed <- MFRI_expand[randomLine,1]
  FireFrequency <- 1/MFRI_expand[randomLine,2]
    }
  }
  
  if(FireFrequency > 1) {FireFrequency = 1}
  
  Tree_vector_height <- rep(0,treeNumbers)
  
 
  for(timeSkip in 1:timeLimit){
        

   Tree_vector_height <- treeGrowth(height_previous = Tree_vector_height, MAP = MAP_seed)


    burnTest <- rbinom(n = 1,
                       size = 1,
                       prob = FireFrequency) 

    if(burnTest == 1)
    {
      
      FireIntensity <- Fxn_FireIntensity_RedoneHistoricalEBP(MAP = MAP_seed,Flat=IntensityFlat) 
      
      
      fireIntensityList <- append(fireIntensityList,FireIntensity)

      Tree_vector_topkills <- rbinom(n=length(Tree_vector_height),size=1,prob=(1 - (inv.logit(-3.9 * log(Tree_vector_height) + .05 * sqrt(FireIntensity) + .3 * 1)))) # Higgins et al. 2012
      Tree_vector_height <- Tree_vector_height * Tree_vector_topkills
      Tree_vector_height <- sort(Tree_vector_height)
      
      
    }
  }
  
  treeHeightList <- append(treeHeightList,Tree_vector_height)
  
  MAP_for_list <- as.character(MAP_seed)
  
  treeHeightsByMAP[[MAP_for_list]] <-treeHeightList
  intensityByMAP[[MAP_for_list]] <-fireIntensityList
  
  treeHeightList <- numeric(0)
  }
  



# Clean up output data ----

treeHeightsByMAP_df <- as.data.frame(treeHeightsByMAP)
treeHeightsByMAP_df$X0 <- NULL

treeHeightsByMAP_df_long <- melt(treeHeightsByMAP_df,variable_name = "MAP")
names(treeHeightsByMAP_df_long) <- c("MAP","Height")
treeHeightsByMAP_df_long$MAP <- as.numeric(as.character(substring(treeHeightsByMAP_df_long$MAP, 2)))

dataLoc <- file.path(paste(simTime,"_treeHeightsByMAP",".csv",sep = ""))
metadataLoc <- file.path(paste(simTime,"_metadata",".csv",sep = ""))
write.csv(x = treeHeightsByMAP_df_long, file=dataLoc)
write.csv(x = simMetadata, file=metadataLoc)


# Clean this up and functionalize it ----

treeHeightsByMAP_df_long$Height_Cuts <- cut(x = treeHeightsByMAP_df_long$Height,
                                            breaks = seq(0,
                                                        ceiling(max(treeHeightsByMAP_df_long$Height)),
                                                         1),
                                            labels = FALSE)

treeHeightsByMAP_df_long$MAP_Cuts <- cut(x = treeHeightsByMAP_df_long$MAP,
                                         right = TRUE,
                                            breaks = seq(400,
                                                         900,
                                                         50))
levels(treeHeightsByMAP_df_long$MAP_Cuts) <- seq(400,900,50)
treeHeightsByMAP_df_long$MAP_Cuts <- as.character(treeHeightsByMAP_df_long$MAP_Cuts)
treeHeightsByMAP_df_long$MAP_Cuts <- as.numeric(treeHeightsByMAP_df_long$MAP_Cuts)


treeHeightsByMAP_df_long_summary <- ddply(.data = treeHeightsByMAP_df_long,.(MAP_Cuts,Height_Cuts),summarize,Count = length(Height_Cuts))
treeHeightsByMAP_df_long_summary <- ddply(.data = treeHeightsByMAP_df_long_summary,.(MAP_Cuts),mutate,Proportion = Count / sum(Count))

#treeHeightsByMAP_df_long_summary$MAP <- as.numeric(as.character(treeHeightsByMAP_df_long_summary$MAP))
#treeHeightsByMAP_df_long_summary <- na.omit(treeHeightsByMAP_df_long_summary)

intensityByMAP_df <- as.data.frame(melt(intensityByMAP))
intensityByMAP_df <- intensityByMAP_df[-1,]
names(intensityByMAP_df) <- c("intensity","MAP")
intensityByMAP_df$MAP <- as.numeric(intensityByMAP_df$MAP)

intensityByMAP_df$MAP_Cuts <- cut(x = intensityByMAP_df$MAP,
                                         right = TRUE,
                                         breaks = seq(400,
                                                      900,
                                                      50))
levels(intensityByMAP_df$MAP_Cuts) <- seq(400,900,50)
intensityByMAP_df$MAP_Cuts <- as.character(intensityByMAP_df$MAP_Cuts)
intensityByMAP_df$MAP_Cuts <- as.numeric(intensityByMAP_df$MAP_Cuts)

intensityByMAP_df$intensity_Cuts <- cut(x = intensityByMAP_df$intensity,
                                  right = TRUE,
                                  breaks = seq(0,
                                               7000,
                                               500))
levels(intensityByMAP_df$intensity_Cuts) <- seq(0,7000,500)
intensityByMAP_df$intensity_Cuts <- as.character(intensityByMAP_df$intensity_Cuts)
intensityByMAP_df$intensity_Cuts <- as.numeric(intensityByMAP_df$intensity_Cuts)


intensityByMAP_summary <- ddply(.data = intensityByMAP_df,.(MAP_Cuts,intensity_Cuts),summarize,Count = length(intensity_Cuts))
intensityByMAP_summary <- ddply(.data = intensityByMAP_summary,.(MAP_Cuts),mutate,Proportion = Count / sum(Count))

intensityByMAP_summary$MAP_Cuts <- as.factor(as.character(intensityByMAP_summary$MAP_Cuts))
intensityByMAP_summary$intensity_Cuts <- as.factor(as.character(intensityByMAP_summary$intensity_Cuts))



pEscape <- ddply(.data = treeHeightsByMAP_df_long,
                 .(MAP_Cuts),
                 summarise,
                 pResult = length(which(Height > 1)) / length(Height)
)

pEscape$MAP <- as.numeric(as.character(pEscape$MAP))

```

# Figures

## Intensity by MAP

```{r fig_FIMAP, echo=FALSE}
FI_recover <- data.frame(MAP = numeric(0),PlotFI=numeric(0))

FI_recover <- rbind(FI_recover,data.frame(Rainfall_mm = rep.int(x = 496,times = 229),PlotFI=NA))
FI_recover <- rbind(FI_recover,data.frame(Rainfall_mm = rep.int(x = 544,times = 342),PlotFI=NA))
FI_recover <- rbind(FI_recover,data.frame(Rainfall_mm = rep.int(x = 550,times = 306),PlotFI=NA))
FI_recover <- rbind(FI_recover,data.frame(Rainfall_mm = rep.int(x = 737,times = 360),PlotFI=NA))
FI_recover$PlotFI <- Fxn_FireIntensity_RedoneHistoricalEBP(MAP = FI_recover$Rainfall_mm)
FI_recover$Type <- "Simulated"
original <- historicalEBP[c("Rainfall_mm","PlotFI")]
original$Type <- "Original"
compareFI <- rbind(FI_recover,original)

MAP_pred <- data.frame(Rainfall_mm = seq(400,900,1))
EBP_Intensity_by_MAP_pred <- predict.glm(object = EBP_Intensity_by_MAP, type = "link", newdata = MAP_pred,se.fit = TRUE)
EBP_Intensity_by_MAP_pred <- tidy(EBP_Intensity_by_MAP_pred)
EBP_Intensity_by_MAP_pred <- cbind(MAP_pred,EBP_Intensity_by_MAP_pred)

EBP_Intensity_by_MAP_pred$upper.ci <- EBP_Intensity_by_MAP_pred$fit+(1.96 * (EBP_Intensity_by_MAP_pred$se.fit))
EBP_Intensity_by_MAP_pred$lower.ci <- EBP_Intensity_by_MAP_pred$fit-(1.96 * (EBP_Intensity_by_MAP_pred$se.fit))
EBP_Intensity_by_MAP_pred$fit <- EBP_Intensity_by_MAP_pred$fit

EBP_Intensity_by_MAP_pred$Published <- Fxn_FireIntensity_Original(EBP_Intensity_by_MAP_pred$Rainfall_mm)

fig_EBP_Intensity_by_MAP <- ggplot(data = EBP_Intensity_by_MAP_pred, aes(x = Rainfall_mm, y = fit))+
  geom_boxplot(data = original, aes(x = Rainfall_mm, y = PlotFI, group = Rainfall_mm),position = "dodge")+
  geom_line(color = "black")+
  geom_line(color = "red", aes( x = Rainfall_mm, y = Published))+
  geom_line(linetype = "dashed", aes(x = Rainfall_mm, y = upper.ci))+
  geom_line(linetype = "dashed", aes(x = Rainfall_mm, y = EBP_Intensity_by_MAP_pred$lower.ci))+
  ylab("Intensity (kW / m^2)")+
  xlab("Mean Annual Precipitation (mm)")+
  cleanTheme
fig_EBP_Intensity_by_MAP

fig_EBP_density <- ggplot(data = compareFI, aes(x = PlotFI, fill = Type))+
  geom_density(alpha = .50)+
 # geom_line(color = "black")+
#  geom_line(color = "red", aes( x = Rainfall_mm, y = Published))+
#  geom_line(linetype = "dashed", aes(x = Rainfall_mm, y = EBP_Intensity_by_MAP_pred$upper.ci))+
 # geom_line(linetype = "dashed", aes(x = Rainfall_mm, y = EBP_Intensity_by_MAP_pred$lower.ci))+
  #ylab("Intensity (kW / m^2)")+
 # xlab("Mean Annual Precipitation (mm)")+
  cleanTheme+
  facet_wrap(~Rainfall_mm)
fig_EBP_density



```

## Growth by MAP

```{r fig_GrowthMAP, echo=FALSE}
dummyMAPDF <- data.frame(MAP = seq(400,900,1))

  Growth <- predict.lm(object = growthModel, newdata = list(MAP = dummyMAPDF$MAP),interval = "confidence")
Growth <- tidy(Growth)
Growth <- cbind(Growth,dummyMAPDF)



fig_GrowthMAP <- ggplot(data = Growth, aes(x = MAP, y = fit))+
  geom_line()+
  geom_line(data = Growth, linetype = "dashed", aes(x = MAP, y = upr))+
  geom_line(data = Growth, linetype = "dashed", aes(x = MAP, y = lwr))+
  ylim(20,75)+
  xlim(400,1000)+
  ylab("Growth Rate (cm / yr)")+
  xlab("Mean Annual Precipitation (mm)")+
  cleanTheme
fig_GrowthMAP

```



## Distribution of Heights by MAP

```{r Fig_heightDistributions}
distributionsPlot <- ggplot(data=treeHeightsByMAP_df_long_summary,aes(x=as.numeric(as.character(Height_Cuts))/100,y = Proportion, fill=as.factor(MAP_Cuts),group=MAP_Cuts))
distributionsPlot+
  cleanTheme+
  scale_fill_discrete("Mean Annual Precipitation (mm/yr)")+
  theme(text = element_text(size = 35),
        legend.background = element_rect(),
        legend.position="none")+
  guides(col = guide_legend(ncol = 4))+
  ylab("Proportion")+
  xlab("Height (m)")+
  geom_bar(stat="identity",binwidth=25, position="dodge")
```

```{r}
glm_pEscape_null <- glm(data = na.omit(pEscape), pResult ~ 1, family = "binomial")
glm_pEscape_MAP <- glm(data = na.omit(pEscape), pResult ~ MAP_Cuts, family = "binomial")

pEscape_pred <- predict.glm(object = glm_pEscape_MAP, type = "link", newdata = list(MAP_Cuts = dummyMAPDF$MAP),se.fit = TRUE)
pEscape_pred <- tidy(pEscape_pred)
pEscape_pred <- cbind(pEscape_pred,dummyMAPDF)

pEscape_pred$upper.ci <- plogis(pEscape_pred$fit+(1.96 * (pEscape_pred$se.fit)))
pEscape_pred$lower.ci <- plogis(pEscape_pred$fit-(1.96 * (pEscape_pred$se.fit)))

pEscape_pred$fit <- inv.logit(pEscape_pred$fit)
#pEscape_pred$se.fit <- inv.logit(pEscape_pred$se.fit)
```

## Probability of Escape by MAP

```{r fig_pEscape, echo=FALSE}


fig_pEscape <- ggplot(data = pEscape, aes(x = MAP_Cuts, y = pResult))+
  geom_point(alpha = .5)+
  ylim(0,1)+
  geom_line(data = pEscape_pred, aes(x = MAP, y = fit))+
  geom_line(linetype = "dashed", data = pEscape_pred, aes(x = MAP, y = upper.ci))+
  geom_line(linetype = "dashed", data = pEscape_pred, aes(x = MAP, y = lower.ci))+
  ylab("p(Escape, 1 m sapling)")+
  xlab("Mean Annual Precipitation (mm/yr)")+
  cleanTheme
fig_pEscape
```